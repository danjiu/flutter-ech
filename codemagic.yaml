workflows:
  ios-build:
    name: iOS Simulator Build Only
    environment:
      vars:
        FLUTTER_VERSION: 3.38.5
        XCODE_VERSION: 26.1
        # å¼ºåˆ¶è®¾ç½®ä¸ºæ¨¡æ‹Ÿå™¨æ„å»º
        FLUTTER_TARGET_PLATFORM: ios-simulator
        CODESIGNING_ALLOWED: NO
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
          source: true
    scripts:
      - name: Clean environment
        script: |
          # å®‰å…¨æ¸…ç†ç¯å¢ƒï¼Œå¿½ç•¥ä¸å­˜åœ¨çš„æ–‡ä»¶
          rm -rf build/ || true
          rm -rf ios/.symlinks/ || true
          rm -rf ios/Pods/ || true
          rm -f ios/Podfile.lock || true
          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"

      - name: Set up Flutter
        script: |
          echo "âš™ï¸ è®¾ç½®Flutter 3.38.5..."

          # æ£€æŸ¥å½“å‰Flutterç‰ˆæœ¬
          echo "å½“å‰Flutterç‰ˆæœ¬:"
          flutter --version

          # å¦‚æœéœ€è¦ï¼Œåˆ‡æ¢åˆ°æ­£ç¡®çš„Flutterç‰ˆæœ¬
          if ! flutter --version | grep -q "3.38.5"; then
            echo "åˆ‡æ¢åˆ°Flutter 3.38.5..."
            flutter channel stable
            flutter upgrade 3.38.5
          fi

          # å†æ¬¡ç¡®è®¤ç‰ˆæœ¬
          echo "æœ€ç»ˆFlutterç‰ˆæœ¬:"
          flutter --version

          # éªŒè¯Dart SDKç‰ˆæœ¬
          echo "Dartç‰ˆæœ¬:"
          dart --version

          # Flutter doctor
          echo "Flutter doctoræ£€æŸ¥:"
          flutter doctor -v

          # é¢„çƒ­Flutter
          echo "é¢„åŠ çƒ­Flutter..."
          flutter precache --ios
          echo "âœ… Flutterè®¾ç½®å®Œæˆ"

      - name: Install dependencies
        script: |
          echo "ğŸ“¦ å®‰è£…Flutterä¾èµ–..."

          # å†æ¬¡ç¡®è®¤Flutterç‰ˆæœ¬
          flutter --version

          # æ¸…ç†ç¼“å­˜
          flutter clean

          # è·å–ä¾èµ–
          echo "è¿è¡Œ flutter pub get..."
          flutter pub get

          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          if [ $? -eq 0 ]; then
            echo "âœ… Flutterä¾èµ–å®‰è£…æˆåŠŸ"
          else
            echo "âŒ Flutterä¾èµ–å®‰è£…å¤±è´¥ï¼Œå°è¯•è§£å†³æ–¹æ¡ˆ..."
            # å°è¯•å‡çº§ä¾èµ–
            flutter pub upgrade
            # å†æ¬¡å°è¯•è·å–
            flutter pub get
          fi

          echo "ä¾èµ–éªŒè¯:"
          flutter pub deps

      - name: Verify iOS Podfile
        script: |
          cd ios
          echo "ğŸ“‹ ç°æœ‰Podfileå†…å®¹:"
          echo "====================="
          cat Podfile
          echo "====================="
          echo "âœ… PodfileéªŒè¯å®Œæˆ"

      - name: Setup Flutter and Install Pods
        script: |
          echo "ğŸ”§ è®¾ç½®Flutterå¹¶å®‰è£…ä¾èµ–..."

          # æ˜¾ç¤ºå½“å‰ç›®å½•å’Œç»“æ„
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ç›®å½•ç»“æ„:"
          ls -la

          # æ£€æŸ¥æ˜¯å¦åœ¨é¡¹ç›®æ ¹ç›®å½•
          if [ ! -f "pubspec.yaml" ]; then
            echo "âŒ ä¸åœ¨Flutteré¡¹ç›®æ ¹ç›®å½•ï¼æ‰¾ä¸åˆ° pubspec.yaml"
            echo "å°è¯•æ‰¾åˆ°é¡¹ç›®æ ¹ç›®å½•..."
            # å°è¯•æ‰¾åˆ°åŒ…å«pubspec.yamlçš„ç›®å½•
            find . -name "pubspec.yaml" -type f 2>/dev/null | head -1
            exit 1
          fi

          echo "âœ… åœ¨Flutteré¡¹ç›®æ ¹ç›®å½•"

          # è¿è¡ŒFlutterçš„ä¾èµ–å®‰è£…
          echo "è¿è¡Œ flutter pub get..."
          flutter pub get

          # æ£€æŸ¥iOSç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "ios" ]; then
            echo "âŒ iOSç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          fi

          # è¿›å…¥iOSç›®å½•
          cd ios
          echo "å·²è¿›å…¥iOSç›®å½•: $(pwd)"

          # æ£€æŸ¥Podfileæ˜¯å¦å­˜åœ¨
          if [ ! -f "Podfile" ]; then
            echo "âŒ Podfileä¸å­˜åœ¨ï¼"
            echo "iOSç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi

          echo "âœ… Podfileå­˜åœ¨"

          # æ¸…ç†å¯èƒ½æŸåçš„æ–‡ä»¶
          echo "æ¸…ç†æ—§çš„CocoaPodsæ–‡ä»¶..."
          rm -rf Pods/
          rm -f Podfile.lock
          rm -f *.xcworkspace

          # æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç›®å½•å†…å®¹:"
          ls -la

          # æ›´æ–°CocoaPodsä»“åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
          echo "æ›´æ–°CocoaPodsä»“åº“..."
          pod repo update || echo "pod repo update å¤±è´¥ï¼Œç»§ç»­..."

          # è¿è¡Œpod install
          echo "è¿è¡Œ pod install..."
          pod install --verbose

          # éªŒè¯å®‰è£…ç»“æœ
          echo "éªŒè¯å®‰è£…ç»“æœ..."
          if [ -f "Podfile.lock" ]; then
            echo "âœ… Podfile.lock ç”ŸæˆæˆåŠŸ"
          else
            echo "âŒ Podfile.lock æœªç”Ÿæˆ"
            exit 1
          fi

          if [ -f "Pods/Manifest.lock" ]; then
            echo "âœ… Manifest.lock å­˜åœ¨"
          else
            echo "âŒ Manifest.lock ä¸å­˜åœ¨"
            echo "Podsç›®å½•å†…å®¹:"
            ls -la Pods/ || echo "Podsç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
          echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          ls -la *.xcworkspace || echo "æ²¡æœ‰æ‰¾åˆ°xcworkspaceæ–‡ä»¶"
          ls -la *.xcodeproj || echo "æ²¡æœ‰æ‰¾åˆ°xcodeprojæ–‡ä»¶"

          # å¦‚æœworkspaceä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨xcodeproj
          if [ -f "Runner.xcworkspace" ]; then
            echo "âœ… workspace æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
            echo "ç”Ÿæˆçš„æ–‡ä»¶:"
            ls -la *.xcworkspace
            ls -la Pods/ | head -10
          elif [ -f "Runner.xcodeproj" ]; then
            echo "âœ… æ‰¾åˆ° xcodeproj æ–‡ä»¶ï¼Œå°†ä½¿ç”¨å®ƒè¿›è¡Œæ„å»º"
            echo "ç”Ÿæˆçš„æ–‡ä»¶:"
            ls -la *.xcodeproj
            ls -la Pods/ | head -10
          else
            echo "âŒ workspace å’Œ xcodeproj æ–‡ä»¶éƒ½æ²¡æœ‰ç”Ÿæˆ"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            echo "æŸ¥æ‰¾ä»»ä½•é¡¹ç›®æ–‡ä»¶:"
            find . -name "*.xcodeproj" -o -name "*.xcworkspace" 2>/dev/null
            exit 1
          fi

      - name: Force Simulator Build
        script: |
          echo "ğŸš€ å¼€å§‹iOSæ¨¡æ‹Ÿå™¨æ„å»º..."

          # æ£€æŸ¥å½“å‰ä½ç½®å¹¶å¯¼èˆªåˆ°é¡¹ç›®æ ¹ç›®å½•
          if [ ! -f "pubspec.yaml" ]; then
            echo "ä¸åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼Œå°è¯•å¯¼èˆª..."
            # CodeMagicé€šå¸¸åœ¨cloneç›®å½•ä¸­è¿è¡Œ
            if [ -d "clone" ]; then
              cd clone
            fi
          fi

          # å†æ¬¡æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•
          if [ ! -f "pubspec.yaml" ]; then
            echo "âŒ ä»ç„¶æ‰¾ä¸åˆ°é¡¹ç›®æ ¹ç›®å½•"
            exit 1
          fi

          echo "å½“å‰ç›®å½•: $(pwd)"

          # è¿›å…¥iOSç›®å½•
          cd ios

          # éªŒè¯å¿…è¦æ–‡ä»¶å­˜åœ¨
          if [ -f "Runner.xcworkspace" ]; then
            PROJECT_FILE="Runner.xcworkspace"
            PROJECT_TYPE="workspace"
            echo "ä½¿ç”¨ workspace æ–‡ä»¶"
          elif [ -f "Runner.xcodeproj" ]; then
            PROJECT_FILE="Runner.xcodeproj"
            PROJECT_TYPE="project"
            echo "ä½¿ç”¨ xcodeproj æ–‡ä»¶"
          else
            echo "âŒ æ‰¾ä¸åˆ° Runner.xcworkspace æˆ– Runner.xcodeprojï¼"
            echo "iOSç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi

          if [ ! -f "Pods/Manifest.lock" ]; then
            echo "âŒ Manifest.lock ä¸å­˜åœ¨ï¼"
            echo "Podsç›®å½•å†…å®¹:"
            ls -la Pods/ || echo "Podsç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          echo "âœ… ä½¿ç”¨ $PROJECT_FILE: $PROJECT_TYPE"

          # åˆ‡æ¢åˆ°Debugé…ç½®ï¼ˆFlutterçš„æ¨¡æ‹Ÿå™¨æ„å»ºæ”¯æŒDebugæ¨¡å¼ï¼‰
          echo "ä½¿ç”¨Debugé…ç½®æ„å»ºæ¨¡æ‹Ÿå™¨ç‰ˆæœ¬..."

          # ä½¿ç”¨xcodebuildæ„å»ºï¼ŒæŒ‡å®šDebugé…ç½®
          if [ "$PROJECT_TYPE" = "workspace" ]; then
            xcodebuild -workspace $PROJECT_FILE \
              -scheme Runner \
              -configuration Debug \
              -sdk iphonesimulator \
              -destination 'generic/platform=iOS Simulator' \
              ONLY_ACTIVE_ARCH=NO \
              CODE_SIGNING_ALLOWED=NO \
              ENABLE_BITCODE=NO \
              build
          else
            xcodebuild -project $PROJECT_FILE \
              -scheme Runner \
              -configuration Debug \
              -sdk iphonesimulator \
              -destination 'generic/platform=iOS Simulator' \
              ONLY_ACTIVE_ARCH=NO \
              CODE_SIGNING_ALLOWED=NO \
              ENABLE_BITCODE=NO \
              build
          fi

          # æ£€æŸ¥æ„å»ºç»“æœ
          if [ $? -eq 0 ]; then
            echo "âœ… iOSæ¨¡æ‹Ÿå™¨æ„å»ºæˆåŠŸï¼"

            # æŸ¥æ‰¾æ„å»ºäº§ç‰©
            BUILD_PRODUCTS_DIR="/Users/builder/Library/Developer/Xcode/DerivedData/Runner-*/Build/Products/Debug-iphonesimulator"
            if ls -la $BUILD_PRODUCTS_DIR/*.app 2>/dev/null; then
              echo "ğŸ“¦ æ„å»ºçš„appæ–‡ä»¶æ‰¾åˆ°"
              ls -la $BUILD_PRODUCTS_DIR/*.app
            fi
          else
            echo "âŒ xcodebuildæ„å»ºå¤±è´¥"

            # å°è¯•ä½¿ç”¨Flutterçš„æ–¹æ³•
            echo "å°è¯•Flutterçš„æ¨¡æ‹Ÿå™¨æ„å»º..."
            cd ..
            flutter build ios --simulator --debug --no-codesign

            if [ $? -eq 0 ]; then
              echo "âœ… Flutteræ¨¡æ‹Ÿå™¨æ„å»ºæˆåŠŸï¼"
            else
              echo "âŒ æ‰€æœ‰æ„å»ºæ–¹æ³•éƒ½å¤±è´¥äº†"
              exit 1
            fi
          fi

      - name: Verify build
        script: |
          # éªŒè¯æ„å»ºäº§ç‰©
          ls -la build/ios/iphonesimulator/ || ls -la build/ios/
          find . -name "*.app" -type d

    artifacts:
      - build/ios/**/Runner.app
      - build/ios/Build/Products/Release-iphonesimulator/*.app
