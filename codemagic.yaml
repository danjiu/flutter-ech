workflows:
  ios-build:
    name: iOS Simulator Build Only
    environment:
      vars:
        FLUTTER_VERSION: 3.38.5
        XCODE_VERSION: 26.1
        # å¼ºåˆ¶è®¾ç½®ä¸ºæ¨¡æ‹Ÿå™¨æ„å»º
        FLUTTER_TARGET_PLATFORM: ios-simulator
        CODESIGNING_ALLOWED: NO
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
          source: true
    scripts:
      - name: Clean environment
        script: |
          # å®‰å…¨æ¸…ç†ç¯å¢ƒï¼Œå¿½ç•¥ä¸å­˜åœ¨çš„æ–‡ä»¶
          rm -rf build/ || true
          rm -rf ios/.symlinks/ || true
          rm -rf ios/Pods/ || true
          rm -f ios/Podfile.lock || true
          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"

      - name: Set up Flutter
        script: |
          echo "âš™ï¸ è®¾ç½®Flutter 3.38.5..."

          # æ£€æŸ¥å½“å‰Flutterç‰ˆæœ¬
          echo "å½“å‰Flutterç‰ˆæœ¬:"
          flutter --version

          # å¦‚æœéœ€è¦ï¼Œåˆ‡æ¢åˆ°æ­£ç¡®çš„Flutterç‰ˆæœ¬
          if ! flutter --version | grep -q "3.38.5"; then
            echo "åˆ‡æ¢åˆ°Flutter 3.38.5..."
            flutter channel stable
            flutter upgrade 3.38.5
          fi

          # å†æ¬¡ç¡®è®¤ç‰ˆæœ¬
          echo "æœ€ç»ˆFlutterç‰ˆæœ¬:"
          flutter --version

          # éªŒè¯Dart SDKç‰ˆæœ¬
          echo "Dartç‰ˆæœ¬:"
          dart --version

          # Flutter doctor
          echo "Flutter doctoræ£€æŸ¥:"
          flutter doctor -v

          # é¢„çƒ­Flutter
          echo "é¢„åŠ çƒ­Flutter..."
          flutter precache --ios
          echo "âœ… Flutterè®¾ç½®å®Œæˆ"

      - name: Install dependencies
        script: |
          echo "ğŸ“¦ å®‰è£…Flutterä¾èµ–..."

          # å†æ¬¡ç¡®è®¤Flutterç‰ˆæœ¬
          flutter --version

          # æ¸…ç†ç¼“å­˜
          flutter clean

          # è·å–ä¾èµ–
          echo "è¿è¡Œ flutter pub get..."
          flutter pub get

          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          if [ $? -eq 0 ]; then
            echo "âœ… Flutterä¾èµ–å®‰è£…æˆåŠŸ"
          else
            echo "âŒ Flutterä¾èµ–å®‰è£…å¤±è´¥ï¼Œå°è¯•è§£å†³æ–¹æ¡ˆ..."
            # å°è¯•å‡çº§ä¾èµ–
            flutter pub upgrade
            # å†æ¬¡å°è¯•è·å–
            flutter pub get
          fi

          echo "ä¾èµ–éªŒè¯:"
          flutter pub deps

      - name: Verify iOS Podfile
        script: |
          cd ios
          echo "ğŸ“‹ ç°æœ‰Podfileå†…å®¹:"
          echo "====================="
          cat Podfile
          echo "====================="
          echo "âœ… PodfileéªŒè¯å®Œæˆ"

      - name: Setup Flutter and Install Pods
        script: |
          echo "ğŸ”§ è®¾ç½®Flutterå¹¶å®‰è£…ä¾èµ–..."

          # è®©Flutterè‡ªåŠ¨å¤„ç†iOSä¾èµ–
          cd ios

          # æ¸…ç†æ—§çš„Podæ–‡ä»¶
          rm -rf Pods/
          rm -f Podfile.lock
          rm -f *.xcworkspace

          # å›åˆ°æ ¹ç›®å½•è¿è¡ŒFlutterå‘½ä»¤
          cd ..

          # è¿è¡ŒFlutterçš„iOSä¾èµ–å®‰è£…
          flutter pub get

          # ä½¿ç”¨Flutterçš„iOSè®¾ç½®
          cd ios
          echo "è¿è¡Œ flutter precache --ios..."
          flutter precache --ios || echo "Flutter precacheå®Œæˆæˆ–è·³è¿‡"

          # å®‰è£…Podsï¼ˆFlutteråº”è¯¥å·²ç»æ›´æ–°äº†Podfileï¼‰
          echo "è¿è¡Œ pod install..."
          pod install --repo-update

          # æ£€æŸ¥ç»“æœ
          if [ -f "Runner.xcworkspace" ]; then
            echo "âœ… CocoaPodså®‰è£…æˆåŠŸ"
            echo "ç”Ÿæˆçš„æ–‡ä»¶:"
            ls -la *.xcworkspace
            ls -la Pods/ || true
          else
            echo "âŒ CocoaPodså®‰è£…å¤±è´¥ï¼Œä½†æ²¡æœ‰Flutteræ’ä»¶ä¹Ÿå¯èƒ½æ˜¯æ­£å¸¸çš„"
            echo "ç»§ç»­æ„å»ºè¿‡ç¨‹..."
          fi

      - name: Force Simulator Build
        script: |
          # è®¾ç½®ç¯å¢ƒå˜é‡å¼ºåˆ¶æ¨¡æ‹Ÿå™¨æ„å»º
          export FLUTTER_TARGET_PLATFORM=ios-simulator
          export CODESIGNING_ALLOWED=NO

          # æ„å»ºæ¨¡æ‹Ÿå™¨ç‰ˆæœ¬
          flutter clean
          flutter pub get

          # é¦–å…ˆæ£€æŸ¥å¯ç”¨çš„æ¨¡æ‹Ÿå™¨
          echo "æ£€æŸ¥å¯ç”¨çš„iOSæ¨¡æ‹Ÿå™¨..."
          xcrun simctl list devices available | grep iOS || echo "æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„æ¨¡æ‹Ÿå™¨"

          # å°è¯•æ„å»ºæ–¹æ³•1ï¼šä½¿ç”¨Flutterçš„é»˜è®¤æ¨¡æ‹Ÿå™¨
          echo "æ–¹æ³•1: ä½¿ç”¨Flutteræ„å»ºiOSæ¨¡æ‹Ÿå™¨ç‰ˆæœ¬..."
          flutter build ios --simulator --release --no-codesign

          # æ£€æŸ¥Flutteræ„å»ºæ˜¯å¦æˆåŠŸ
          if [ -d "build/ios/iphonesimulator/Runner.app" ]; then
            echo "âœ… Flutteræ¨¡æ‹Ÿå™¨æ„å»ºæˆåŠŸï¼"
            echo "æ„å»ºäº§ç‰©ä½ç½®: build/ios/iphonesimulator/Runner.app"
          else
            echo "Flutteræ„å»ºå¤±è´¥ï¼Œå°è¯•xcodebuildæ–¹æ³•..."

            # æ–¹æ³•2ï¼šä½¿ç”¨é€šç”¨ç›®æ ‡è€Œä¸æ˜¯ç‰¹å®šè®¾å¤‡
            echo "æ–¹æ³•2: ä½¿ç”¨xcodebuildé€šç”¨æ¨¡æ‹Ÿå™¨ç›®æ ‡..."
            xcodebuild -workspace ios/Runner.xcworkspace \
              -scheme Runner \
              -configuration Release \
              -sdk iphonesimulator \
              -destination 'generic/platform=iOS Simulator' \
              ONLY_ACTIVE_ARCH=NO \
              CODE_SIGNING_ALLOWED=NO \
              ENABLE_BITCODE=NO \
              build || \

            # æ–¹æ³•3ï¼šå°è¯•ä½¿ç”¨ä»»ä½•å¯ç”¨çš„æ¨¡æ‹Ÿå™¨
            echo "æ–¹æ³•3: ä½¿ç”¨ä»»ä½•å¯ç”¨çš„æ¨¡æ‹Ÿå™¨..."
            xcodebuild -workspace ios/Runner.xcworkspace \
              -scheme Runner \
              -configuration Release \
              -sdk iphonesimulator \
              -destination 'platform=iOS Simulator' \
              ONLY_ACTIVE_ARCH=NO \
              CODE_SIGNING_ALLOWED=NO \
              ENABLE_BITCODE=NO \
              build

            # æ£€æŸ¥xcodebuildç»“æœ
            if [ $? -eq 0 ]; then
              echo "âœ… xcodebuildæ¨¡æ‹Ÿå™¨æ„å»ºæˆåŠŸï¼"
            else
              echo "âŒ æ‰€æœ‰æ„å»ºæ–¹æ³•éƒ½å¤±è´¥äº†"
              exit 1
            fi
          fi

      - name: Verify build
        script: |
          # éªŒè¯æ„å»ºäº§ç‰©
          ls -la build/ios/iphonesimulator/ || ls -la build/ios/
          find . -name "*.app" -type d

    artifacts:
      - build/ios/**/Runner.app
      - build/ios/Build/Products/Release-iphonesimulator/*.app
