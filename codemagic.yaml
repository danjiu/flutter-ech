workflows:
  ios-build:
    name: iOS Simulator Build Only
    environment:
      vars:
        FLUTTER_VERSION: 3.38.5
        XCODE_VERSION: 26.1
        # å¼ºåˆ¶è®¾ç½®ä¸ºæ¨¡æ‹Ÿå™¨æž„å»º
        FLUTTER_TARGET_PLATFORM: ios-simulator
        CODESIGNING_ALLOWED: NO
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
          source: true
    scripts:
      - name: Clean environment
        script: |
          # å®‰å…¨æ¸…ç†çŽ¯å¢ƒï¼Œå¿½ç•¥ä¸å­˜åœ¨çš„æ–‡ä»¶
          rm -rf build/ || true
          rm -rf ios/.symlinks/ || true
          rm -rf ios/Pods/ || true
          rm -f ios/Podfile.lock || true
          echo "âœ… çŽ¯å¢ƒæ¸…ç†å®Œæˆ"

      - name: Set up Flutter
        script: |
          echo "âš™ï¸ è®¾ç½®Flutter 3.38.5..."

          # æ£€æŸ¥å½“å‰Flutterç‰ˆæœ¬
          echo "å½“å‰Flutterç‰ˆæœ¬:"
          flutter --version

          # å¦‚æžœéœ€è¦ï¼Œåˆ‡æ¢åˆ°æ­£ç¡®çš„Flutterç‰ˆæœ¬
          if ! flutter --version | grep -q "3.38.5"; then
            echo "åˆ‡æ¢åˆ°Flutter 3.38.5..."
            flutter channel stable
            flutter upgrade 3.38.5
          fi

          # å†æ¬¡ç¡®è®¤ç‰ˆæœ¬
          echo "æœ€ç»ˆFlutterç‰ˆæœ¬:"
          flutter --version

          # éªŒè¯Dart SDKç‰ˆæœ¬
          echo "Dartç‰ˆæœ¬:"
          dart --version

          # Flutter doctor
          echo "Flutter doctoræ£€æŸ¥:"
          flutter doctor -v

          # é¢„çƒ­Flutter
          echo "é¢„åŠ çƒ­Flutter..."
          flutter precache --ios
          echo "âœ… Flutterè®¾ç½®å®Œæˆ"

      - name: Install dependencies
        script: |
          echo "ðŸ“¦ å®‰è£…Flutterä¾èµ–..."

          # å†æ¬¡ç¡®è®¤Flutterç‰ˆæœ¬
          flutter --version

          # æ¸…ç†ç¼“å­˜
          flutter clean

          # èŽ·å–ä¾èµ–
          echo "è¿è¡Œ flutter pub get..."
          flutter pub get

          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          if [ $? -eq 0 ]; then
            echo "âœ… Flutterä¾èµ–å®‰è£…æˆåŠŸ"
          else
            echo "âŒ Flutterä¾èµ–å®‰è£…å¤±è´¥ï¼Œå°è¯•è§£å†³æ–¹æ¡ˆ..."
            # å°è¯•å‡çº§ä¾èµ–
            flutter pub upgrade
            # å†æ¬¡å°è¯•èŽ·å–
            flutter pub get
          fi

          echo "ä¾èµ–éªŒè¯:"
          flutter pub deps

      - name: Fix iOS Podfile
        script: |
          cd ios
          # åˆ›å»ºä¸€ä¸ªç®€åŒ–çš„Podfileï¼Œé¿å…é—®é¢˜ä¾èµ–
          cat > Podfile << 'EOF'
          platform :ios, '15.0'

          target 'Runner' do
            use_frameworks!
            use_modular_headers!

            flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
          end

          post_install do |installer|
            installer.pods_project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
                config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
                config.build_settings['ENABLE_BITCODE'] = 'NO'
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
              end
            end
          end
          EOF

          echo "âœ… Podfileåˆ›å»ºå®Œæˆ"

      - name: Install Pods
        script: |
          cd ios
          pod install --repo-update

      - name: Force Simulator Build
        script: |
          # è®¾ç½®çŽ¯å¢ƒå˜é‡å¼ºåˆ¶æ¨¡æ‹Ÿå™¨æž„å»º
          export FLUTTER_TARGET_PLATFORM=ios-simulator
          export CODESIGNING_ALLOWED=NO

          # æž„å»ºæ¨¡æ‹Ÿå™¨ç‰ˆæœ¬ï¼Œæ˜Žç¡®æŒ‡å®šè®¾å¤‡
          flutter clean
          flutter pub get

          # ä½¿ç”¨xcodebuildç›´æŽ¥æž„å»ºæ¨¡æ‹Ÿå™¨ç‰ˆæœ¬
          xcodebuild -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGNING_ALLOWED=NO \
            ENABLE_BITCODE=NO \
            build

          # å¦‚æžœxcodebuildå¤±è´¥ï¼Œå°è¯•Flutteræ–¹æ³•
          if [ $? -ne 0 ]; then
            echo "Flutter fallback method..."
            flutter build ios --simulator --release --no-codesign
          fi

      - name: Verify build
        script: |
          # éªŒè¯æž„å»ºäº§ç‰©
          ls -la build/ios/iphonesimulator/ || ls -la build/ios/
          find . -name "*.app" -type d

    artifacts:
      - build/ios/**/Runner.app
      - build/ios/Build/Products/Release-iphonesimulator/*.app

